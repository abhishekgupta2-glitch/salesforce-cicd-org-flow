name: Deploy to CRM_DevTrial after PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - CRM_DevTrial2

jobs:
  deploy-after-merge:
    runs-on: ubuntu-latest
    # Only run if PR was merged (not just closed) and from promotional branch
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'promo/')
    
    permissions:
      contents: write
      pull-requests: write
      checks: write
    
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          # Use merge commit SHA to ensure we have the merged state
          ref: ${{ github.event.pull_request.merge_commit_sha }}
      
      # Step 2: Configure Git
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Step 3: Setup Node
      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      # Step 4: Install Salesforce CLI
      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      # Step 5: Install sfdx-git-delta
      - name: Install sfdx git delta
        run: |
          echo Y | sfdx plugins:install sfdx-git-delta
          sfdx plugins

      # Step 6: Verify PR Merge Status
      - name: Verify PR Merge Status
        id: verify-merge
        run: |
          echo "[INFO] PR #${{ github.event.pull_request.number }} was merged"
          echo "[INFO] Merged by: ${{ github.event.pull_request.merged_by.login }}"
          echo "[INFO] Merge commit: ${{ github.event.pull_request.merge_commit_sha }}"
          echo "[INFO] Source branch: ${{ github.event.pull_request.head.ref }}"
          echo "[INFO] Target branch: ${{ github.event.pull_request.base.ref }}"
          echo "merge_verified=true" >> $GITHUB_OUTPUT

      # Step 7: Generate Delta Packages
      - name: Create delta packages
        id: delta-generation
        if: steps.verify-merge.outputs.merge_verified == 'true'
        run: |
          mkdir -p changed-sources
          BASE_BRANCH="CRM_DevTrial2"
          MERGE_COMMIT="${{ github.event.pull_request.merge_commit_sha }}"
          
          echo "[INFO] PR was merged - comparing base branch to merge commit"
          echo "[INFO] Merge commit: $MERGE_COMMIT"
          
          # Fetch base branch to ensure we have the reference
          git fetch origin "$BASE_BRANCH" || git fetch origin main
          
          # Get the base commit (parent of merge commit, which is the base branch state before merge)
          # Merge commit has two parents: first parent is base branch, second is head branch
          BASE_COMMIT=$(git rev-parse ${MERGE_COMMIT}^1 2>/dev/null || git rev-parse origin/$BASE_BRANCH 2>/dev/null || git rev-parse origin/main)
          
          echo "[INFO] Base commit (before merge): $BASE_COMMIT"
          echo "[INFO] Merge commit: $(git rev-parse HEAD)"
          
          # Generate delta from base (before merge) to merge commit
          sf sgd source delta \
            --from "$BASE_COMMIT" \
            --to "$MERGE_COMMIT" \
            --output "changed-sources" \
            --generate-delta \
            --source "force-app" || {
              echo "[WARN] Delta generation failed or no changes detected"
              echo "has_changes=false" >> $GITHUB_OUTPUT
              exit 0
            }
          
          echo "[INFO] Delta generation complete"
          
          if [ -d "changed-sources/force-app" ] && [ "$(ls -A changed-sources/force-app 2>/dev/null)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "[INFO] Changes detected in force-app"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "[INFO] No changes detected in force-app"
          fi

      # Step 8: Authorize CRM_DevTrial org (JWT)
      - name: Authorize CRM_DevTrial Org (JWT)
        if: steps.verify-merge.outputs.merge_verified == 'true' && steps.delta-generation.outputs.has_changes == 'true'
        run: |
          echo "${{ secrets.SF_JWT_KEY_DEVTRIAL }}" > server.key
          sf org login jwt \
            --username "${{ secrets.SF_USERNAME_DEVTRIAL }}" \
            --jwt-key-file server.key \
            --client-id "${{ secrets.SF_CLIENT_ID_DEVTRIAL }}" \
            --instance-url "${{ secrets.SF_INSTANCE_URL_DEVTRIAL }}" \
            --set-default \
            --alias CRM_DevTrial

      # Step 9: Deploy Delta Changes to CRM_DevTrial
      - name: Deploy Delta Changes to CRM_DevTrial
        if: steps.verify-merge.outputs.merge_verified == 'true' && steps.delta-generation.outputs.has_changes == 'true'
        id: deploy-delta
        run: |
          echo "[INFO] Deploying delta changes to CRM_DevTrial org..."
          
          if [ ! -d "changed-sources/force-app" ] || [ -z "$(ls -A changed-sources/force-app 2>/dev/null)" ]; then
            echo "[INFO] No changes to deploy. Skipping deployment."
            echo "deployment_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Deploy delta changes
          sf project deploy start \
            --source-dir changed-sources/force-app \
            --target-org CRM_DevTrial \
            --wait 10 \
            --json > deploy_results.json || {
              echo "[ERROR] Deployment failed"
              cat deploy_results.json
              echo "deployment_success=false" >> $GITHUB_OUTPUT
              exit 1
            }
          
          echo "[INFO] ‚úÖ Deployment successful"
          echo "deployment_success=true" >> $GITHUB_OUTPUT
          
          DEPLOY_STATUS=$(jq -r '.status' deploy_results.json 2>/dev/null || echo "unknown")
          echo "[INFO] Deployment status: $DEPLOY_STATUS"

      # Step 10: Run Apex Tests and Check Org-Wide Coverage
      - name: Run Apex Tests and Check Org-Wide Coverage
        if: steps.verify-merge.outputs.merge_verified == 'true' && steps.deploy-delta.outputs.deployment_success == 'true'
        id: apex
        continue-on-error: false
        run: |
          echo "[INFO] Running all local tests to validate org-wide coverage"
          
          set +e
          sf apex run test \
            --test-level RunLocalTests \
            --target-org CRM_DevTrial \
            --code-coverage \
            --json \
            --wait 120 > test_results.json 2>&1
          TEST_EXIT_CODE=$?
          set -e
          
          echo "[INFO] Test execution exit code: $TEST_EXIT_CODE"
          
          if [ ! -f test_results.json ] || [ ! -s test_results.json ]; then
            echo "[ERROR] Test results file is missing or empty"
            exit 1
          fi
          
          if grep -qi "no.*test.*found\|no.*apex.*test\|no tests in org" test_results.json 2>/dev/null; then
            echo "[WARN] No tests found in org."
            cat test_results.json
            echo "coverage=N/A" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "[ERROR] Test execution failed with exit code $TEST_EXIT_CODE"
            cat test_results.json | head -100
            exit 1
          fi
          
          TEST_STATUS=$(jq -r '.status // "unknown"' test_results.json 2>/dev/null || echo "unknown")
          echo "[INFO] Test status: $TEST_STATUS"
          
          if [ "$TEST_STATUS" != "0" ] && [ "$TEST_STATUS" != "success" ]; then
            echo "[ERROR] Tests failed. Status: $TEST_STATUS"
            jq '.result.summary' test_results.json 2>/dev/null || cat test_results.json
            exit 1
          fi
          
          # Calculate coverage
          TOTAL_COVERED=$(jq -r '[.result.codeCoverage[]?.numLinesCovered // 0] | add' test_results.json 2>/dev/null || echo "0")
          TOTAL_UNCOVERED=$(jq -r '[.result.codeCoverage[]?.numLinesUncovered // 0] | add' test_results.json 2>/dev/null || echo "0")
          TOTAL_LINES=$((TOTAL_COVERED + TOTAL_UNCOVERED))
          
          if [ "$TOTAL_LINES" -gt 0 ]; then
            COVERAGE=$(echo "scale=2; $TOTAL_COVERED * 100 / $TOTAL_LINES" | bc)
            echo "[INFO] Org-wide coverage: $COVERAGE% (Covered: $TOTAL_COVERED, Total: $TOTAL_LINES)"
          else
            COVERAGE_RAW=$(jq -r '.result.summary.orgWideCoverage // 0' test_results.json 2>/dev/null || echo "0")
            COVERAGE=$(echo "$COVERAGE_RAW" | sed 's/%//g' | sed 's/[^0-9.]//g' | tr -d ' ')
            
            if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "0" ] || [ "$COVERAGE" = "null" ]; then
              echo "[WARN] Could not calculate org-wide coverage"
              echo "coverage=N/A" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "[INFO] Org-wide coverage from summary: $COVERAGE%"
          fi
          
          COVERAGE_CLEAN=$(echo "$COVERAGE" | sed 's/[^0-9.]//g')
          COVERAGE_NUM=$(echo "$COVERAGE_CLEAN" | awk '{print $1+0}')
          
          echo "coverage=$COVERAGE_NUM" >> $GITHUB_OUTPUT
          
          if awk "BEGIN {exit !($COVERAGE_NUM <= 75)}"; then
            echo "[ERROR] Org-wide coverage must be greater than 75% (Current: $COVERAGE_NUM%)"
            jq '.result.summary' test_results.json 2>/dev/null || cat test_results.json | head -50
            exit 1
          fi
          
          echo "[INFO] ‚úÖ Org-wide coverage validation passed: $COVERAGE_NUM%"

      # Step 11: Comment on PR and Send Email Notification
      - name: Comment on PR and Send Email Notification
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.pull_request.number;
            const merged = context.payload.pull_request?.merged === true;
            const mergedBy = context.payload.pull_request?.merged_by?.login || 'Unknown';
            const deploymentSuccess = '${{ steps.deploy-delta.outputs.deployment_success }}' === 'true';
            const coverage = '${{ steps.apex.outputs.coverage }}';
            const jobStatus = '${{ job.status }}';
            const mergeCommit = context.payload.pull_request?.merge_commit_sha || 'N/A';
            const promoBranch = context.payload.pull_request?.head?.ref || 'N/A';
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            let comment = `## Deployment Status\n\n`;
            
            if (merged && jobStatus === 'success' && deploymentSuccess) {
              comment += `‚úÖ **Status:** Deployment successful\n`;
              comment += `**Merged by:** @${mergedBy}\n`;
              comment += `**Org-Wide Coverage:** ${coverage}%\n`;
              comment += `‚úÖ Changes deployed to CRM_DevTrial\n`;
              comment += `‚úÖ Tests passed\n`;
            } else if (merged && jobStatus === 'success' && !deploymentSuccess) {
              comment += `‚ÑπÔ∏è **Status:** No changes to deploy\n`;
            } else if (merged && jobStatus === 'failure') {
              comment += `‚ùå **Status:** Deployment failed\n`;
              comment += `Please check the workflow logs for details.\n`;
            } else {
              comment += `‚ö†Ô∏è **Status:** Deployment workflow completed with status: ${jobStatus}\n`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
            
            // Prepare email content
            const emailSubject = 'DevTrial Deployment ' + (jobStatus === 'success' ? 'Successful' : 'Failed') + ' - PR #' + prNumber;
            
            const statusMessage = jobStatus === 'success' && deploymentSuccess
              ? '‚úÖ All validations passed\n‚úÖ Changes deployed to CRM_DevTrial\n‚úÖ Tests passed\n‚úÖ Coverage requirement met (>75%)'
              : '‚ùå Deployment failed or validation errors occurred\nPlease check the workflow logs for details:\n' + context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;
            
            const emailBody = 'DevTrial Environment Deployment Summary\n' +
              '========================================\n\n' +
              'PR Details:\n' +
              '-----------\n' +
              'PR Number: #' + prNumber + '\n' +
              'PR Title: ' + pr.title + '\n' +
              'Promotional Branch: ' + promoBranch + '\n' +
              'Merge Commit: ' + mergeCommit + '\n' +
              'Merged By: ' + mergedBy + '\n' +
              'Merged At: ' + pr.merged_at + '\n\n' +
              'Deployment Status:\n' +
              '------------------\n' +
              'Status: ' + (jobStatus === 'success' ? '‚úÖ SUCCESS' : '‚ùå FAILED') + '\n' +
              'Deployment: ' + (deploymentSuccess ? '‚úÖ Successful' : '‚ùå Failed') + '\n' +
              'Org-Wide Coverage: ' + coverage + '%\n\n' +
              statusMessage + '\n\n' +
              'Workflow Information:\n' +
              '--------------------\n' +
              'Repository: ' + context.repo.owner + '/' + context.repo.repo + '\n' +
              'Workflow: ' + context.workflow + '\n' +
              'Run ID: ' + context.runId + '\n' +
              'Run URL: ' + context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + '\n\n' +
              '---\n' +
              'This is an automated message from GitHub Actions.';
            
            // Send email using curl to email service (configure EMAIL_API_URL and EMAIL_API_KEY)
            // Example: SendGrid, AWS SES, or custom email service
            const emailApiUrl = process.env.EMAIL_API_URL || '${{ secrets.EMAIL_API_URL }}';
            const emailApiKey = process.env.EMAIL_API_KEY || '${{ secrets.EMAIL_API_KEY }}';
            const recipientEmail = process.env.RECIPIENT_EMAIL || '${{ secrets.DEPLOYMENT_NOTIFICATION_EMAIL }}';
            
            if (emailApiUrl && emailApiKey && recipientEmail && emailApiUrl !== '' && emailApiUrl !== '${{ secrets.EMAIL_API_URL }}') {
              try {
                const { execSync } = require('child_process');
                const emailPayload = JSON.stringify({
                  to: recipientEmail,
                  subject: emailSubject,
                  body: emailBody,
                  html: emailBody.replace(/\n/g, '<br>')
                });
                
                execSync(`curl -X POST "${emailApiUrl}" \
                  -H "Authorization: Bearer ${emailApiKey}" \
                  -H "Content-Type: application/json" \
                  -d '${emailPayload}'`, { stdio: 'inherit' });
                
                console.log(`‚úÖ Email sent to ${recipientEmail}`);
              } catch (emailError) {
                console.log(`‚ö†Ô∏è Email sending failed: ${emailError.message}`);
                console.log('üìß Email content prepared but not sent (check email service configuration)');
              }
            } else {
              console.log('üìß Email notification skipped (email service not configured)');
              console.log('üìß Email content prepared:');
              console.log(`Subject: ${emailSubject}`);
              console.log(`To: ${recipientEmail || 'Not configured'}`);
            }

      # Step 12: Summary
      - name: Summary
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR Status:** Merged ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "**Merged by:** ${{ github.event.pull_request.merged_by.login }}" >> $GITHUB_STEP_SUMMARY
          echo "**Merge Commit:** ${{ github.event.pull_request.merge_commit_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment:** ${{ steps.deploy-delta.outputs.deployment_success }}" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ steps.apex.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ **Deployment completed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Deployment failed - Check logs for details**" >> $GITHUB_STEP_SUMMARY
          fi
