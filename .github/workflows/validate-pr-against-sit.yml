name: Validation PR against SIT

on:
  pull_request:
    branches:
      - CRM_Dev1
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  validate-pr-against-sit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      checks: write
    
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      # Step 2: Setup Node
      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      # Step 3: Install Salesforce CLI
      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      # Step 4: Install sfdx-git-delta
      - name: Install sfdx git delta
        run: |
          echo Y | sfdx plugins:install sfdx-git-delta
          sfdx plugins

      # Step 5: Generate Delta Packages
      - name: Create delta packages
        run: |
          mkdir -p changed-sources
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          
          echo "[INFO] Comparing $BASE_BRANCH to $HEAD_BRANCH"
          
          git fetch origin $BASE_BRANCH
          PREV_COMMIT=$(git rev-parse origin/$BASE_BRANCH)
          
          sf sgd source delta \
            --from "$PREV_COMMIT" \
            --to "HEAD" \
            --output "changed-sources" \
            --generate-delta \
            --source "force-app"
          
          echo "[INFO] Delta generation complete"
          echo "[INFO] Listing delta output:"
          ls -R changed-sources || echo "No changes detected"
          echo "[INFO] All changed files:"
          find changed-sources -type f 2>/dev/null || echo "No files found"

      # Step 6: Authorize SIT org (JWT)
      - name: Authorize SIT Org (JWT)
        run: |
          echo "[INFO] Setting up JWT authentication..."
          # Create server.key file with proper formatting
          echo "${{ secrets.SF_JWT_KEY_DEVTRIAL }}" > server.key
          
          # Verify key file was created
          if [ ! -f server.key ]; then
            echo "[ERROR] Failed to create server.key file"
            exit 1
          fi
          
          # Verify key file has content
          if [ ! -s server.key ]; then
            echo "[ERROR] server.key file is empty"
            exit 1
          fi
          
          echo "[INFO] Attempting JWT authentication..."
          sf org login jwt \
            --username "${{ secrets.SF_USERNAME_DEVTRIAL }}" \
            --jwt-key-file server.key \
            --client-id "${{ secrets.SF_CLIENT_ID_DEVTRIAL }}" \
            --instance-url "${{ secrets.SF_INSTANCE_URL_DEVTRIAL }}" \
            --set-default \
            --alias CRM_DevTrial || {
              echo "[ERROR] JWT authentication failed"
              echo "[INFO] Please verify:"
              echo "  - JWT key matches the Connected App"
              echo "  - Username is correct"
              echo "  - Consumer Key (Client ID) is correct"
              echo "  - Instance URL is correct"
              exit 1
            }
          
          echo "[INFO] ✅ Successfully authenticated to Salesforce org"

      # Step 7: Check for Apex classes in changes
      - name: Check for Apex Classes
        id: check-apex
        continue-on-error: true
        run: |
          echo "[INFO] Checking for Apex classes in changes..."
          APEX_CLASSES=0
          APEX_TEST_CLASSES=0
          
          if [ -d "changed-sources/force-app" ]; then
            echo "[INFO] changed-sources/force-app directory exists"
            # Find Apex classes (excluding test classes and metadata files)
            APEX_CLASSES=$(find changed-sources/force-app -type f -name "*.cls" ! -name "*Test.cls" ! -name "*.cls-meta.xml" 2>/dev/null | wc -l | tr -d ' ')
            # Find test classes
            APEX_TEST_CLASSES=$(find changed-sources/force-app -type f -name "*Test.cls" ! -name "*.cls-meta.xml" 2>/dev/null | wc -l | tr -d ' ')
            
            echo "[INFO] Found $APEX_CLASSES Apex class(es) and $APEX_TEST_CLASSES test class(es) in changes"
            
            # Debug: List found files
            if [ "$APEX_CLASSES" -gt 0 ]; then
              echo "[INFO] Apex classes found:"
              find changed-sources/force-app -type f -name "*.cls" ! -name "*Test.cls" ! -name "*.cls-meta.xml" 2>/dev/null
            fi
          else
            echo "[INFO] changed-sources/force-app directory does not exist"
          fi
          
          # Set outputs (default to false if check fails)
          if [ "$APEX_CLASSES" -gt 0 ]; then
            echo "has_apex_classes=true" >> $GITHUB_OUTPUT
          else
            echo "has_apex_classes=false" >> $GITHUB_OUTPUT
          fi
          
          if [ "$APEX_TEST_CLASSES" -gt 0 ]; then
            echo "has_test_classes=true" >> $GITHUB_OUTPUT
          else
            echo "has_test_classes=false" >> $GITHUB_OUTPUT
          fi
          
          echo "apex_classes_count=$APEX_CLASSES" >> $GITHUB_OUTPUT
          echo "[INFO] Final decision: has_apex_classes=$([ $APEX_CLASSES -gt 0 ] && echo 'true' || echo 'false')"

      # Step 8: Run Apex Tests and Check Org-Wide Coverage
      - name: Run Apex Tests and Check Org-Wide Coverage
        id: apex
        if: steps.check-apex.outputs.has_apex_classes == 'true'
        run: |
          echo "[INFO] Apex classes detected. Attempting to run tests to validate org-wide coverage..."
          echo "[INFO] Note: If no tests exist in the org, this step will skip validation gracefully."
          
          # Run tests and capture both stdout and stderr
          set +e  # Don't exit on error immediately
          sf apex run test \
            --test-level RunLocalTests \
            --target-org CRM_DevTrial \
            --code-coverage \
            --json \
            --wait 120 > test_results.json 2>test_errors.log
          TEST_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          echo "[INFO] Test command completed with exit code: $TEST_EXIT_CODE"
          
          # Check if test execution failed
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "[WARN] Test execution returned exit code: $TEST_EXIT_CODE"
            
            # Check error log first
            ERROR_LOG_CONTENT=""
            if [ -f test_errors.log ] && [ -s test_errors.log ]; then
              ERROR_LOG_CONTENT=$(cat test_errors.log)
              echo "[INFO] Error log contents:"
              echo "$ERROR_LOG_CONTENT"
            fi
            
            # Check test results file
            ERROR_MESSAGE=""
            if [ -f test_results.json ] && [ -s test_results.json ]; then
              echo "[INFO] Test results file contents:"
              cat test_results.json
              # Try to extract error message from JSON
              ERROR_MESSAGE=$(jq -r '.message // .result.message // .cause.message // empty' test_results.json 2>/dev/null || echo "")
            fi
            
            # Check if the error is "no tests in org" (check both error log and JSON)
            if echo "$ERROR_MESSAGE $ERROR_LOG_CONTENT" | grep -qiE "no.*apex.*test.*run.*org|no.*test.*to.*run|invalid_input.*test"; then
              echo "[INFO] ⚠️ No Apex tests found in the org. This is acceptable if tests haven't been deployed yet."
              echo "[INFO] Skipping test validation - tests will be required once deployed to the org."
              echo "coverage=N/A" >> $GITHUB_OUTPUT
              echo "[INFO] ✅ Test validation skipped (no tests in org)"
              exit 0
            fi
            
            # If it's a different error, fail the workflow
            echo "[ERROR] Test execution failed with a different error"
            echo "[INFO] Attempting to parse error details:"
            if [ -f test_results.json ] && [ -s test_results.json ]; then
              jq '.' test_results.json 2>/dev/null || cat test_results.json
            fi
            exit 1
          fi
          
          # Check if test_results.json has valid content
          if [ ! -f test_results.json ] || [ ! -s test_results.json ]; then
            echo "[ERROR] Test results file is empty or does not exist"
            exit 1
          fi
          
          # Display test summary
          echo "[INFO] Test execution completed. Parsing results..."
          TEST_SUMMARY=$(jq -r '.result.summary // empty' test_results.json 2>/dev/null)
          if [ -z "$TEST_SUMMARY" ]; then
            echo "[WARN] Could not parse test summary, showing full results:"
            jq '.' test_results.json || cat test_results.json
          else
            echo "[INFO] Test Summary:"
            jq '.result.summary' test_results.json
          fi
          
          # Calculate org-wide coverage from codeCoverage array
          TOTAL_COVERED=$(jq -r '[.result.codeCoverage[]?.numLinesCovered // 0] | add' test_results.json)
          TOTAL_UNCOVERED=$(jq -r '[.result.codeCoverage[]?.numLinesUncovered // 0] | add' test_results.json)
          TOTAL_LINES=$((TOTAL_COVERED + TOTAL_UNCOVERED))
          
          if [ "$TOTAL_LINES" -gt 0 ]; then
            COVERAGE=$(echo "scale=2; $TOTAL_COVERED * 100 / $TOTAL_LINES" | bc)
            echo "[INFO] Org-wide coverage: $COVERAGE% (Covered: $TOTAL_COVERED, Total: $TOTAL_LINES)"
          else
            # Fallback to orgWideCoverage from summary if available
            COVERAGE=$(jq -r '.result.summary.orgWideCoverage // 0' test_results.json)
            if [ "$COVERAGE" = "0" ] || [ -z "$COVERAGE" ] || [ "$COVERAGE" = "null" ]; then
              echo "[ERROR] Could not calculate org-wide coverage"
              exit 1
            fi
            echo "[INFO] Org-wide coverage from summary: $COVERAGE%"
          fi
          
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          
          # Validate org-wide coverage > 75%
          if (( $(echo "$COVERAGE <= 75" | bc -l) )); then
            echo "[ERROR] Org-wide coverage must be greater than 75% (Current: $COVERAGE%)"
            echo "[INFO] Test results summary:"
            jq '.result.summary' test_results.json
            exit 1
          fi
          
          echo "[INFO] ✅ Org-wide coverage validation passed: $COVERAGE%"
      
      # Step 8b: Skip tests if no Apex classes
      - name: Skip Tests - No Apex Classes
        id: apex-skip
        if: steps.check-apex.outputs.has_apex_classes == 'false'
        run: |
          echo "[INFO] No Apex classes detected in changes. Skipping test execution."
          echo "coverage=N/A" >> $GITHUB_OUTPUT
          echo "[INFO] ✅ Test validation skipped (no Apex classes to test)"

      # Step 8: Validate Changes
      - name: Validate Changes
        id: validate-changes
        run: |
          if [ -d "changed-sources/force-app" ] && [ "$(ls -A changed-sources/force-app 2>/dev/null)" ]; then
            echo "[INFO] Changes detected in force-app"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "[WARN] No changes detected in force-app"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      # Step 9: Comment on PR
      - name: Comment PR Status
        uses: actions/github-script@v6
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const hasChanges = '${{ steps.validate-changes.outputs.has_changes }}' === 'true';
            const hasApexClasses = '${{ steps.check-apex.outputs.has_apex_classes }}' === 'true';
            const coverage = '${{ steps.apex.outputs.coverage || steps.apex-skip.outputs.coverage }}';
            const workflowStatus = '${{ job.status }}';
            const isSuccess = workflowStatus === 'success';
            
            let status, message;
            if (isSuccess && hasChanges) {
              status = '✅';
              if (hasApexClasses && coverage !== 'N/A') {
                message = `**Validation Status:** ✅ Passed\n\n**Org-Wide Coverage:** ${coverage}% (Required: >75%)\n\n✅ Changes validated against SIT org\n✅ Tests passed\n✅ Org-wide coverage validated\n✅ Ready for review and approval`;
              } else if (!hasApexClasses) {
                message = `**Validation Status:** ✅ Passed\n\n**Note:** No Apex classes detected in changes. Test validation skipped.\n\n✅ Changes validated against SIT org\n✅ Ready for review and approval`;
              } else if (hasApexClasses && coverage === 'N/A') {
                message = `**Validation Status:** ✅ Passed\n\n**Note:** Apex classes detected, but no tests found in the org. Test validation skipped.\n⚠️ Tests will be required once deployed to the org.\n\n✅ Changes validated against SIT org\n✅ Ready for review and approval`;
              } else {
                message = `**Validation Status:** ✅ Passed\n\n✅ Changes validated against SIT org\n✅ Ready for review and approval`;
              }
            } else if (isSuccess && !hasChanges) {
              status = '⚠️';
              message = `**Validation Status:** ⚠️ No changes detected\n\nPlease verify this PR contains the expected changes.`;
            } else {
              status = '❌';
              const coverageMsg = coverage && coverage !== 'N/A' ? `**Org-Wide Coverage:** ${coverage}% (Required: >75%)\n\n` : '';
              message = `**Validation Status:** ❌ Failed\n\n${coverageMsg}Please fix the issues and update the PR.`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## PR Validation Results (SIT)\n\n${message}\n\n**Branch:** \`${{ github.event.pull_request.head.ref }}\`\n**Base:** \`${{ github.event.pull_request.base.ref }}\``
            });

      # Step 10: Summary
      - name: Summary
        if: always()
        run: |
          COVERAGE="${{ steps.apex.outputs.coverage || steps.apex-skip.outputs.coverage }}"
          echo "### Validation Summary (SIT)" >> $GITHUB_STEP_SUMMARY
          echo "**Delta created:** Yes" >> $GITHUB_STEP_SUMMARY
          if [ "$COVERAGE" = "N/A" ]; then
            echo "**Org-Wide Coverage:** N/A (No Apex classes detected)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Org-Wide Coverage:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Validation against SIT:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** ${{ github.event.pull_request.html_url }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ **Status:** Validation passed - PR ready for approval" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status:** Validation failed - Please fix issues" >> $GITHUB_STEP_SUMMARY
          fi
