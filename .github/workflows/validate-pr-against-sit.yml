name: Feature Branch Validation and Promotion

on:
  push:
    branches:
      - 'feature/**'  # Triggers on push to any feature branch
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  precheck-and-promote:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      checks: write
    
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}
      
      # Step 1b: Configure Git
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Step 2: Setup Node
      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      # Step 3: Install Salesforce CLI
      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      # Step 4: Install sfdx-git-delta (needed for delta generation)
      - name: Install sfdx git delta
        run: |
          echo Y | sfdx plugins:install sfdx-git-delta
          sfdx plugins

      # Step 5: Generate Delta Packages (BEFORE PMD to check only changed files)
      - name: Create delta packages
        id: delta-generation
        run: |
          mkdir -p changed-sources
          FEATURE_BRANCH="${GITHUB_REF#refs/heads/}"
          
          echo "[INFO] Comparing CRM_DevTrial to $FEATURE_BRANCH"
          
          # Fetch CRM_DevTrial branch
          git fetch origin CRM_DevTrial || {
            echo "[WARN] CRM_DevTrial branch not found, comparing to main"
            git fetch origin main
            BASE_BRANCH="main"
          }
          
          BASE_BRANCH="CRM_DevTrial"
          PREV_COMMIT=$(git rev-parse origin/$BASE_BRANCH 2>/dev/null || git rev-parse origin/main)
          
          echo "[INFO] Base commit: $PREV_COMMIT"
          echo "[INFO] Current commit: $(git rev-parse HEAD)"
          
          # Generate delta
          sf sgd source delta \
            --from "$PREV_COMMIT" \
            --to "HEAD" \
            --output "changed-sources" \
            --generate-delta \
            --source "force-app" || {
              echo "[WARN] Delta generation failed or no changes detected"
              echo "has_changes=false" >> $GITHUB_OUTPUT
              exit 0
            }
          
          echo "[INFO] Delta generation complete"
          echo "[INFO] Listing delta output:"
          ls -R changed-sources || echo "No changes detected"
          
          # Check if there are actual changes
          if [ -d "changed-sources/force-app" ] && [ "$(ls -A changed-sources/force-app 2>/dev/null)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "[INFO] Changes detected in force-app"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "[INFO] No changes detected in force-app"
          fi

      # Step 6: Install PMD using reliable method
      - name: Install PMD
        id: install-pmd
        continue-on-error: true
        run: |
          echo "[INFO] Installing PMD for Apex code analysis..."
          
          # Install Java (required for PMD)
          sudo apt-get update -qq
          sudo apt-get install -y openjdk-17-jdk unzip curl -qq
          java -version
          
          PMD_INSTALLED=false
          
          # Try Method 1: PMD 7.0.0 with correct URL
          echo "[INFO] Method 1: Downloading PMD 7.0.0..."
          PMD_VERSION="7.0.0"
          PMD_URL="https://github.com/pmd/pmd/releases/download/pmd_releases%2F${PMD_VERSION}/pmd-bin-${PMD_VERSION}.zip"
          
          DOWNLOAD_OUTPUT=$(curl -L -w "%{http_code}" -o pmd-bin.zip "$PMD_URL" 2>&1)
          HTTP_CODE=$(echo "$DOWNLOAD_OUTPUT" | tail -1)
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
            if [ -f pmd-bin.zip ] && [ -s pmd-bin.zip ] && file pmd-bin.zip | grep -q "Zip archive"; then
              echo "[INFO] PMD zip file downloaded successfully"
              unzip -q pmd-bin.zip
              
              if [ -d "pmd-bin-${PMD_VERSION}" ]; then
                sudo mkdir -p /opt/pmd
                sudo cp -r pmd-bin-${PMD_VERSION}/* /opt/pmd/
                sudo chmod +x /opt/pmd/bin/pmd
                echo "/opt/pmd/bin" >> $GITHUB_PATH
                
                if /opt/pmd/bin/pmd --version 2>&1 | head -1; then
                  PMD_INSTALLED=true
                  echo "pmd_available=true" >> $GITHUB_OUTPUT
                  echo "pmd_method=direct" >> $GITHUB_OUTPUT
                  echo "[INFO] ✅ PMD 7.0.0 installed successfully"
                fi
              fi
            fi
          fi
          
          # Try Method 2: PMD 6.55.0 if 7.0.0 failed
          if [ "$PMD_INSTALLED" != "true" ]; then
            echo "[INFO] Method 2: Trying PMD 6.55.0..."
            PMD_VERSION="6.55.0"
            PMD_URL="https://github.com/pmd/pmd/releases/download/pmd_releases%2F${PMD_VERSION}/pmd-bin-${PMD_VERSION}.zip"
            
            rm -f pmd-bin.zip
            DOWNLOAD_OUTPUT=$(curl -L -w "%{http_code}" -o pmd-bin.zip "$PMD_URL" 2>&1)
            HTTP_CODE=$(echo "$DOWNLOAD_OUTPUT" | tail -1)
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
              if [ -f pmd-bin.zip ] && [ -s pmd-bin.zip ] && file pmd-bin.zip | grep -q "Zip archive"; then
                unzip -q pmd-bin.zip
                if [ -d "pmd-bin-${PMD_VERSION}" ]; then
                  sudo mkdir -p /opt/pmd
                  sudo cp -r pmd-bin-${PMD_VERSION}/* /opt/pmd/
                  sudo chmod +x /opt/pmd/bin/pmd
                  echo "/opt/pmd/bin" >> $GITHUB_PATH
                  
                  if /opt/pmd/bin/pmd --version 2>&1 | head -1; then
                    PMD_INSTALLED=true
                    echo "pmd_available=true" >> $GITHUB_OUTPUT
                    echo "pmd_method=direct_v6" >> $GITHUB_OUTPUT
                    echo "[INFO] ✅ PMD 6.55.0 installed successfully"
                  fi
                fi
              fi
            fi
          fi
          
          # Try Method 3: Salesforce Code Analyzer as fallback
          if [ "$PMD_INSTALLED" != "true" ]; then
            echo "[INFO] Method 3: Installing Salesforce Code Analyzer as fallback..."
            if npm install -g @salesforce/sfdx-scanner 2>&1; then
              if npx @salesforce/sfdx-scanner --version 2>&1 || npm list -g @salesforce/sfdx-scanner 2>&1; then
                echo "pmd_available=true" >> $GITHUB_OUTPUT
                echo "pmd_method=scanner" >> $GITHUB_OUTPUT
                PMD_INSTALLED=true
                echo "[INFO] ✅ Salesforce Code Analyzer installed as fallback"
              fi
            fi
          fi
          
          if [ "$PMD_INSTALLED" != "true" ]; then
            echo "[WARN] All PMD installation methods failed. Will use enhanced code validation instead."
            echo "pmd_available=false" >> $GITHUB_OUTPUT
            echo "pmd_method=none" >> $GITHUB_OUTPUT
          fi

      # Step 7: Create PMD Ruleset File
      - name: Create PMD Ruleset
        run: |
          echo "[INFO] Creating PMD ruleset file for Apex..."
          mkdir -p .pmd
          
          cat > .pmd/apex-ruleset.xml << 'EOF'
          <?xml version="1.0"?>
          <ruleset name="Apex Rules"
                   xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd">
            <description>PMD ruleset for Apex code quality checks</description>
            <rule ref="category/apex/security.xml"/>
            <rule ref="category/apex/performance.xml"/>
            <rule ref="category/apex/bestpractices.xml"/>
          </ruleset>
          EOF
          
          echo "[INFO] ✅ PMD ruleset created at .pmd/apex-ruleset.xml"

      # Step 8: Run PMD Apex Checks on DELTA CHANGES ONLY
      - name: Run PMD Apex Checks
        id: pmd-check
        continue-on-error: false
        run: |
          echo "[INFO] Running PMD Apex checks on delta changes..."
          PMD_AVAILABLE="${{ steps.install-pmd.outputs.pmd_available }}"
          PMD_METHOD="${{ steps.install-pmd.outputs.pmd_method }}"
          HAS_CHANGES="${{ steps.delta-generation.outputs.has_changes }}"
          
          # Check if there are changes first
          if [ "$HAS_CHANGES" != "true" ]; then
            echo "[INFO] No changes detected in force-app. PMD checks skipped."
            echo "pmd_passed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Find Apex classes in DELTA only
          APEX_FILES=""
          if [ -d "changed-sources/force-app" ]; then
            APEX_FILES=$(find changed-sources/force-app -name "*.cls" -not -name "*.cls-meta.xml" 2>/dev/null || true)
          fi
          
          # Proper null check - handle empty string
          if [ -z "$APEX_FILES" ] || [ "$APEX_FILES" = "" ]; then
            echo "[INFO] No Apex classes found in delta changes. PMD checks passed (no Apex code to check)."
            echo "pmd_passed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "[INFO] Found Apex files in delta to check:"
          echo "$APEX_FILES" | head -10
          
          # If PMD is not available, perform enhanced validation
          if [ "$PMD_AVAILABLE" != "true" ] || [ -z "$PMD_METHOD" ] || [ "$PMD_METHOD" = "none" ]; then
            echo "[WARN] PMD not available. Performing enhanced Apex code validation on delta..."
            VIOLATION_COUNT=0
            VIOLATIONS_FOUND=""
            
            for APEX_FILE in $APEX_FILES; do
              FILE_VIOLATIONS=0
              FILE_NAME=$(basename "$APEX_FILE")
              
              echo "[DEBUG] Checking file: $FILE_NAME"
              
              # Check 1: SOQL in loops
              AWK_RESULT=$(awk '
                /for\s*\(|while\s*\(/ { in_loop=1; loop_brace=0 }
                in_loop && /\{/ { loop_brace++ }
                in_loop && loop_brace > 0 && /\[SELECT/ { found_soql=1 }
                in_loop && /\}/ { 
                  loop_brace--
                  if (loop_brace == 0) { in_loop=0 }
                }
                END { exit !found_soql }
              ' "$APEX_FILE" 2>&1)
              AWK_EXIT=$?
              
              if [ $AWK_EXIT -eq 0 ]; then
                echo "[ERROR] $FILE_NAME: SOQL query inside loop detected (Performance violation)"
                VIOLATIONS_FOUND="${VIOLATIONS_FOUND}\n- $FILE_NAME: SOQL in loop"
                FILE_VIOLATIONS=$((FILE_VIOLATIONS + 1))
                echo "[DEBUG] SOQL violation detected in $FILE_NAME"
              fi
              
              # Check 2: DML in loops
              AWK_RESULT=$(awk '
                /for\s*\(|while\s*\(/ { in_loop=1; loop_brace=0 }
                in_loop && /\{/ { loop_brace++ }
                in_loop && loop_brace > 0 && /\b(insert|update|delete|upsert|undelete)\s+/ { found_dml=1 }
                in_loop && /\}/ { 
                  loop_brace--
                  if (loop_brace == 0) { in_loop=0 }
                }
                END { exit !found_dml }
              ' "$APEX_FILE" 2>&1)
              AWK_EXIT=$?
              
              if [ $AWK_EXIT -eq 0 ]; then
                echo "[ERROR] $FILE_NAME: DML operation inside loop detected (Performance violation)"
                VIOLATIONS_FOUND="${VIOLATIONS_FOUND}\n- $FILE_NAME: DML in loop"
                FILE_VIOLATIONS=$((FILE_VIOLATIONS + 1))
                echo "[DEBUG] DML violation detected in $FILE_NAME"
              fi
              
              # Check 3: Empty catch blocks
              if grep -qE "catch\s*\([^)]*\)\s*\{\s*\}" "$APEX_FILE" 2>/dev/null || \
                 grep -A 2 -E "catch\s*\([^)]*\)\s*\{" "$APEX_FILE" 2>/dev/null | grep -qE "^\s*\}" || \
                 awk '/catch\s*\([^)]*\)\s*\{/{catch_line=NR; next} catch_line && NR==catch_line+1 && /^\s*\}/{empty=1} catch_line && NR>catch_line+1 && !/^\s*\/\//{catch_line=0} END{exit !empty}' "$APEX_FILE" 2>/dev/null; then
                echo "[ERROR] $FILE_NAME: Empty catch block detected (Best practice violation)"
                VIOLATIONS_FOUND="${VIOLATIONS_FOUND}\n- $FILE_NAME: Empty catch block"
                FILE_VIOLATIONS=$((FILE_VIOLATIONS + 1))
              fi
              
              # Check 4: Hardcoded IDs
              if grep -qE "'00[0-9a-zA-Z]{15,18}'" "$APEX_FILE" 2>/dev/null; then
                echo "[WARN] $FILE_NAME: Hardcoded Salesforce ID detected (Best practice violation)"
                VIOLATIONS_FOUND="${VIOLATIONS_FOUND}\n- $FILE_NAME: Hardcoded ID"
                FILE_VIOLATIONS=$((FILE_VIOLATIONS + 1))
              fi
              
              # Check 5: Basic syntax
              if ! grep -qE "(public|private|global|@isTest).*(class|interface)" "$APEX_FILE" 2>/dev/null; then
                echo "[ERROR] $FILE_NAME: Invalid Apex class structure"
                VIOLATIONS_FOUND="${VIOLATIONS_FOUND}\n- $FILE_NAME: Invalid class structure"
                FILE_VIOLATIONS=$((FILE_VIOLATIONS + 1))
              fi
              
              if [ $FILE_VIOLATIONS -eq 0 ]; then
                echo "[INFO] Basic validation passed for: $FILE_NAME"
              fi
              
              VIOLATION_COUNT=$((VIOLATION_COUNT + FILE_VIOLATIONS))
            done
            
            # Debug: Show violation count
            echo "[DEBUG] Total violations found: $VIOLATION_COUNT"
            
            if [ $VIOLATION_COUNT -gt 0 ]; then
              echo "[ERROR] ========================================="
              echo "[ERROR] Found $VIOLATION_COUNT PMD violation(s):"
              echo "[ERROR] ========================================="
              echo -e "$VIOLATIONS_FOUND"
              echo "[ERROR] ========================================="
              echo "pmd_passed=false" >> $GITHUB_OUTPUT
              echo "[ERROR] PMD validation FAILED - Fix violations before proceeding"
              exit 1
            else
              echo "[INFO] ✅ Enhanced validation passed (PMD unavailable, but no violations found)"
              echo "pmd_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # PMD is available - run full PMD checks on DELTA
          echo "[INFO] PMD is available via method: $PMD_METHOD"
          
          # If using Salesforce Code Analyzer
          if [ "$PMD_METHOD" = "scanner" ]; then
            echo "[INFO] Using Salesforce Code Analyzer for PMD checks on delta..."
            set +e
            PMD_OUTPUT=$(npx @salesforce/sfdx-scanner scanner:run \
              --target "changed-sources/force-app" \
              --format json \
              --category "Security,Apex Performance,Apex Best Practices" \
              2>&1)
            PMD_EXIT_CODE=$?
            set -e
            
            echo "[INFO] Scanner Exit Code: $PMD_EXIT_CODE"
            echo "[INFO] Scanner Output (first 200 lines):"
            echo "$PMD_OUTPUT" | head -200
            
            if [ $PMD_EXIT_CODE -eq 0 ]; then
              VIOLATION_COUNT=$(echo "$PMD_OUTPUT" | jq -r '[.result[]?.violations[]?] | length' 2>/dev/null || echo "0")
              
              if [ "$VIOLATION_COUNT" -gt 0 ]; then
                echo "[ERROR] Salesforce Code Analyzer found $VIOLATION_COUNT violation(s)"
                echo "[INFO] Violations details:"
                echo "$PMD_OUTPUT" | jq '.result[] | select(.violations != null and (.violations | length > 0))' 2>/dev/null || echo "$PMD_OUTPUT"
                echo "pmd_passed=false" >> $GITHUB_OUTPUT
                exit 1
              else
                echo "[INFO] ✅ Salesforce Code Analyzer checks passed - No violations found"
                echo "pmd_passed=true" >> $GITHUB_OUTPUT
                exit 0
              fi
            else
              echo "[WARN] Salesforce Code Analyzer returned exit code $PMD_EXIT_CODE. Falling back to enhanced validation..."
              # Fall through to enhanced validation
            fi
          fi
          
          # Find PMD command (for direct PMD installation)
          PMD_CMD=""
          if command -v pmd &> /dev/null; then
            PMD_CMD="pmd"
          elif [ -f "/opt/pmd/bin/pmd" ]; then
            PMD_CMD="/opt/pmd/bin/pmd"
          fi
          
          if [ -z "$PMD_CMD" ] || ! "$PMD_CMD" --version &>/dev/null; then
            echo "[WARN] PMD command not found or not working. Falling back to enhanced validation..."
            VIOLATION_COUNT=0
            VIOLATIONS_FOUND=""
            
            for APEX_FILE in $APEX_FILES; do
              FILE_NAME=$(basename "$APEX_FILE")
              
              if awk '/for|while/{in_loop=1} in_loop && /\[SELECT/{found=1} /^[[:space:]]*\}/{in_loop=0} END{exit !found}' "$APEX_FILE" 2>/dev/null; then
                echo "[ERROR] $FILE_NAME: SOQL in loop"
                VIOLATIONS_FOUND="${VIOLATIONS_FOUND}\n- $FILE_NAME: SOQL in loop"
                VIOLATION_COUNT=$((VIOLATION_COUNT + 1))
              fi
              
              if awk '/for|while/{in_loop=1} in_loop && /(insert|update|delete|upsert)[[:space:]]+[^;]*;/{found=1} /^[[:space:]]*\}/{in_loop=0} END{exit !found}' "$APEX_FILE" 2>/dev/null; then
                echo "[ERROR] $FILE_NAME: DML in loop"
                VIOLATIONS_FOUND="${VIOLATIONS_FOUND}\n- $FILE_NAME: DML in loop"
                VIOLATION_COUNT=$((VIOLATION_COUNT + 1))
              fi
              
              if grep -qE "catch[[:space:]]*\([^)]*\)[[:space:]]*\{[[:space:]]*\}" "$APEX_FILE" 2>/dev/null; then
                echo "[ERROR] $FILE_NAME: Empty catch block"
                VIOLATIONS_FOUND="${VIOLATIONS_FOUND}\n- $FILE_NAME: Empty catch block"
                VIOLATION_COUNT=$((VIOLATION_COUNT + 1))
              fi
            done
            
            # Debug: Show violation count
            echo "[DEBUG] Total violations found: $VIOLATION_COUNT"
            
            if [ $VIOLATION_COUNT -gt 0 ]; then
              echo "[ERROR] ========================================="
              echo "[ERROR] Found $VIOLATION_COUNT violation(s):"
              echo "[ERROR] ========================================="
              echo -e "$VIOLATIONS_FOUND"
              echo "[ERROR] ========================================="
              echo "pmd_passed=false" >> $GITHUB_OUTPUT
              echo "[ERROR] PMD validation FAILED - Fix violations before proceeding"
              exit 1
            else
              echo "[INFO] ✅ Enhanced validation passed"
              echo "pmd_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "[INFO] Using PMD command: $PMD_CMD"
          "$PMD_CMD" --version
          
          # Run PMD on DELTA directory only
          set +e
          if [ -f ".pmd/apex-ruleset.xml" ]; then
            echo "[INFO] Running PMD with ruleset file on delta changes..."
            PMD_OUTPUT=$("$PMD_CMD" check -d changed-sources/force-app -R .pmd/apex-ruleset.xml -f json 2>&1)
            PMD_EXIT_CODE=$?
          else
            echo "[INFO] Running PMD with category rules on delta changes..."
            PMD_OUTPUT=$("$PMD_CMD" check -d changed-sources/force-app \
              -R category/apex/security.xml,category/apex/performance.xml,category/apex/bestpractices.xml \
              -f json 2>&1)
            PMD_EXIT_CODE=$?
          fi
          set -e
          
          echo "[INFO] PMD Exit Code: $PMD_EXIT_CODE"
          echo "[INFO] PMD Output (first 200 lines):"
          echo "$PMD_OUTPUT" | head -200
          
          # PMD exit codes: 0 = no violations, 4 = violations found
          if [ $PMD_EXIT_CODE -eq 4 ]; then
            VIOLATION_COUNT=$(echo "$PMD_OUTPUT" | jq -r '[.files[].violations[]?] | length' 2>/dev/null || echo "0")
            
            if [ "$VIOLATION_COUNT" -gt 0 ]; then
              echo "[ERROR] PMD found $VIOLATION_COUNT violation(s)"
              echo "[INFO] PMD violations details:"
              echo "$PMD_OUTPUT" | jq '.files[] | select(.violations != null and (.violations | length > 0))' 2>/dev/null || echo "$PMD_OUTPUT"
              echo "pmd_passed=false" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "[INFO] PMD exit code 4 but no violations parsed. Treating as passed."
              echo "pmd_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          elif [ $PMD_EXIT_CODE -eq 0 ]; then
            echo "[INFO] ✅ PMD checks passed - No violations found"
            echo "pmd_passed=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "[WARN] PMD execution returned exit code $PMD_EXIT_CODE"
            echo "[WARN] Falling back to enhanced validation..."
            
            VIOLATION_COUNT=0
            VIOLATIONS_FOUND=""
            
            for APEX_FILE in $APEX_FILES; do
              FILE_NAME=$(basename "$APEX_FILE")
              
              if awk '/for|while/{in_loop=1} in_loop && /\[SELECT/{found=1} /^[[:space:]]*\}/{in_loop=0} END{exit !found}' "$APEX_FILE" 2>/dev/null; then
                echo "[ERROR] $FILE_NAME: SOQL in loop"
                VIOLATIONS_FOUND="${VIOLATIONS_FOUND}\n- $FILE_NAME: SOQL in loop"
                VIOLATION_COUNT=$((VIOLATION_COUNT + 1))
              fi
              
              if awk '/for|while/{in_loop=1} in_loop && /(insert|update|delete|upsert)[[:space:]]+[^;]*;/{found=1} /^[[:space:]]*\}/{in_loop=0} END{exit !found}' "$APEX_FILE" 2>/dev/null; then
                echo "[ERROR] $FILE_NAME: DML in loop"
                VIOLATIONS_FOUND="${VIOLATIONS_FOUND}\n- $FILE_NAME: DML in loop"
                VIOLATION_COUNT=$((VIOLATION_COUNT + 1))
              fi
              
              if grep -qE "catch[[:space:]]*\([^)]*\)[[:space:]]*\{[[:space:]]*\}" "$APEX_FILE" 2>/dev/null; then
                echo "[ERROR] $FILE_NAME: Empty catch block"
                VIOLATIONS_FOUND="${VIOLATIONS_FOUND}\n- $FILE_NAME: Empty catch block"
                VIOLATION_COUNT=$((VIOLATION_COUNT + 1))
              fi
            done
            
            # Debug: Show violation count
            echo "[DEBUG] Total violations found: $VIOLATION_COUNT"
            
            if [ $VIOLATION_COUNT -gt 0 ]; then
              echo "[ERROR] ========================================="
              echo "[ERROR] Found $VIOLATION_COUNT violation(s):"
              echo "[ERROR] ========================================="
              echo -e "$VIOLATIONS_FOUND"
              echo "[ERROR] ========================================="
              echo "pmd_passed=false" >> $GITHUB_OUTPUT
              echo "[ERROR] PMD validation FAILED - Fix violations before proceeding"
              exit 1
            else
              echo "[INFO] ✅ Enhanced validation passed (PMD execution error)"
              echo "pmd_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

      # Step 9: Create Promotional Branch from CRM_DevTrial
      - name: Create Promotional Branch
        if: steps.pmd-check.outputs.pmd_passed == 'true'
        id: create-promo-branch
        run: |
          FEATURE_BRANCH="${GITHUB_REF#refs/heads/}"
          FEATURE_NUM=$(echo "$FEATURE_BRANCH" | sed 's/feature\///g' | sed 's/feature-//g')
          PROMO_BRANCH="promo/$FEATURE_NUM"
          
          echo "[INFO] Feature branch: $FEATURE_BRANCH"
          echo "[INFO] Creating promotional branch: $PROMO_BRANCH"
          
          git fetch origin CRM_DevTrial || git fetch origin main
          git fetch origin "$FEATURE_BRANCH"
          
          if git ls-remote --heads origin "$PROMO_BRANCH" | grep -q "$PROMO_BRANCH"; then
            echo "[INFO] Promotional branch already exists, checking it out"
            git fetch origin "$PROMO_BRANCH"
            git checkout "$PROMO_BRANCH"
            git reset --hard origin/"$PROMO_BRANCH"
          else
            git checkout -b "$PROMO_BRANCH" origin/CRM_DevTrial || git checkout -b "$PROMO_BRANCH" origin/main
          fi
          
          git merge "origin/$FEATURE_BRANCH" -m "Merge $FEATURE_BRANCH into promotional branch" || {
            echo "[ERROR] Failed to merge feature branch into promotional branch"
            exit 1
          }
          
          echo "promo_branch=$PROMO_BRANCH" >> $GITHUB_OUTPUT
          echo "[INFO] ✅ Promotional branch created and feature branch merged"

      # Step 10: Authorize CRM_DevTrial org (JWT)
      - name: Authorize CRM_DevTrial Org (JWT)
        if: steps.pmd-check.outputs.pmd_passed == 'true'
        run: |
          echo "${{ secrets.SF_JWT_KEY_DEVTRIAL }}" > server.key
          sf org login jwt \
            --username "${{ secrets.SF_USERNAME_DEVTRIAL }}" \
            --jwt-key-file server.key \
            --client-id "${{ secrets.SF_CLIENT_ID_DEVTRIAL }}" \
            --instance-url "${{ secrets.SF_INSTANCE_URL_DEVTRIAL }}" \
            --set-default \
            --alias CRM_DevTrial

      # Step 11: Deploy Delta Changes to CRM_DevTrial
      - name: Deploy Delta Changes to CRM_DevTrial
        if: steps.pmd-check.outputs.pmd_passed == 'true' && steps.delta-generation.outputs.has_changes == 'true'
        id: deploy-delta
        run: |
          echo "[INFO] Deploying delta changes to CRM_DevTrial org..."
          
          if [ ! -d "changed-sources/force-app" ] || [ -z "$(ls -A changed-sources/force-app 2>/dev/null)" ]; then
            echo "[INFO] No changes to deploy. Skipping deployment."
            echo "deployment_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Deploy delta changes
          sf project deploy start \
            --source-dir changed-sources/force-app \
            --target-org CRM_DevTrial \
            --wait 10 \
            --json > deploy_results.json || {
              echo "[ERROR] Deployment failed"
              cat deploy_results.json
              exit 1
            }
          
          echo "[INFO] ✅ Deployment successful"
          echo "deployment_success=true" >> $GITHUB_OUTPUT
          
          # Check deployment status
          DEPLOY_STATUS=$(jq -r '.status' deploy_results.json 2>/dev/null || echo "unknown")
          echo "[INFO] Deployment status: $DEPLOY_STATUS"

      # Step 12: Run Apex Tests and Check Org-Wide Coverage
      - name: Run Apex Tests and Check Org-Wide Coverage
        if: steps.pmd-check.outputs.pmd_passed == 'true'
        id: apex
        continue-on-error: false
        run: |
          echo "[INFO] Running all local tests to validate org-wide coverage"
          
          # Run tests with better error handling
          set +e
          sf apex run test \
            --test-level RunLocalTests \
            --target-org CRM_DevTrial \
            --code-coverage \
            --json \
            --wait 120 > test_results.json 2>&1
          TEST_EXIT_CODE=$?
          set -e
          
          echo "[INFO] Test execution exit code: $TEST_EXIT_CODE"
          
          # Check if test_results.json exists and has content
          if [ ! -f test_results.json ] || [ ! -s test_results.json ]; then
            echo "[ERROR] Test results file is missing or empty"
            exit 1
          fi
          
          # Check for common error patterns
          if grep -qi "no.*test.*found\|no.*apex.*test\|no tests in org" test_results.json 2>/dev/null; then
            echo "[WARN] No tests found in org. This might be expected if no test classes are deployed."
            echo "[INFO] Test results:"
            cat test_results.json
            echo "coverage=N/A" >> $GITHUB_OUTPUT
            echo "[INFO] Skipping coverage check - no tests found"
            exit 0
          fi
          
          # Check if test execution failed
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "[ERROR] Test execution failed with exit code $TEST_EXIT_CODE"
            echo "[INFO] Test results:"
            cat test_results.json | head -100
            exit 1
          fi
          
          # Parse test results
          TEST_STATUS=$(jq -r '.status // "unknown"' test_results.json 2>/dev/null || echo "unknown")
          echo "[INFO] Test status: $TEST_STATUS"
          
          if [ "$TEST_STATUS" != "0" ] && [ "$TEST_STATUS" != "success" ]; then
            echo "[ERROR] Tests failed. Status: $TEST_STATUS"
            echo "[INFO] Test summary:"
            jq '.result.summary' test_results.json 2>/dev/null || cat test_results.json
            exit 1
          fi
          
          # Calculate coverage
          TOTAL_COVERED=$(jq -r '[.result.codeCoverage[]?.numLinesCovered // 0] | add' test_results.json 2>/dev/null || echo "0")
          TOTAL_UNCOVERED=$(jq -r '[.result.codeCoverage[]?.numLinesUncovered // 0] | add' test_results.json 2>/dev/null || echo "0")
          TOTAL_LINES=$((TOTAL_COVERED + TOTAL_UNCOVERED))
          
          echo "[DEBUG] Coverage calculation: Covered=$TOTAL_COVERED, Uncovered=$TOTAL_UNCOVERED, Total=$TOTAL_LINES"
          
          if [ "$TOTAL_LINES" -gt 0 ]; then
            COVERAGE=$(echo "scale=2; $TOTAL_COVERED * 100 / $TOTAL_LINES" | bc)
            echo "[INFO] Org-wide coverage: $COVERAGE% (Covered: $TOTAL_COVERED, Total: $TOTAL_LINES)"
          else
            # Fallback to orgWideCoverage from summary
            COVERAGE=$(jq -r '.result.summary.orgWideCoverage // 0' test_results.json 2>/dev/null || echo "0")
            if [ "$COVERAGE" = "0" ] || [ -z "$COVERAGE" ] || [ "$COVERAGE" = "null" ]; then
              echo "[WARN] Could not calculate org-wide coverage from codeCoverage array or summary"
              echo "[INFO] Test results summary:"
              jq '.result.summary' test_results.json 2>/dev/null || cat test_results.json | head -50
              echo "coverage=N/A" >> $GITHUB_OUTPUT
              echo "[INFO] Coverage check skipped - unable to calculate"
              exit 0
            fi
            echo "[INFO] Org-wide coverage from summary: $COVERAGE%"
          fi
          
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          
          # Validate org-wide coverage > 75%
          if (( $(echo "$COVERAGE <= 75" | bc -l) )); then
            echo "[ERROR] Org-wide coverage must be greater than 75% (Current: $COVERAGE%)"
            echo "[INFO] Test results summary:"
            jq '.result.summary' test_results.json 2>/dev/null || cat test_results.json | head -50
            exit 1
          fi
          
          echo "[INFO] ✅ Org-wide coverage validation passed: $COVERAGE%"

      # Step 13: Push Promotional Branch and Create/Update PR
      - name: Push Promotional Branch and Create/Update PR
        if: steps.pmd-check.outputs.pmd_passed == 'true' && steps.apex.outputs.coverage != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const promoBranch = '${{ steps.create-promo-branch.outputs.promo_branch }}';
            const featureBranch = '${GITHUB_REF#refs/heads/}';
            const coverage = '${{ steps.apex.outputs.coverage }}';
            const deploymentSuccess = '${{ steps.deploy-delta.outputs.deployment_success }}' === 'true';
            
            // Push promotional branch
            const { execSync } = require('child_process');
            try {
              execSync(`git push origin ${promoBranch}`, { stdio: 'inherit' });
              console.log(`✅ Promotional branch ${promoBranch} pushed successfully`);
            } catch (error) {
              console.log(`⚠️ Error pushing branch, continuing...`);
            }
            
            // Check if PR already exists
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${promoBranch}`,
              base: 'CRM_DevTrial',
              state: 'open'
            });
            
            const prBody = `## Promotional Branch Validation Results\n\n**Feature Branch:** \`${featureBranch}\`\n**Promotional Branch:** \`${promoBranch}\`\n\n**Validation Status:** ✅ Passed\n\n**Org-Wide Coverage:** ${coverage}% (Required: >75%)\n\n✅ PMD checks passed\n✅ Tests passed\n✅ Org-wide coverage validated\n${deploymentSuccess ? '✅ Changes deployed to CRM_DevTrial' : '⚠️ No changes to deploy'}\n✅ Ready for review and merge`;
            
            if (existingPRs.length > 0) {
              // Update existing PR
              const existingPR = existingPRs[0];
              console.log(`ℹ️ PR already exists: ${existingPR.html_url}`);
              
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: existingPR.number,
                body: prBody,
                title: `Promotional Branch: ${promoBranch} (Updated)`
              });
              
              console.log(`✅ PR updated: ${existingPR.html_url}`);
            } else {
              // Create new PR
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Promotional Branch: ${promoBranch}`,
                head: promoBranch,
                base: 'CRM_DevTrial',
                body: prBody
              });
              
              console.log(`✅ PR created: ${pr.html_url}`);
            }

      # Step 14: Summary
      - name: Summary
        if: always()
        run: |
          echo "### Feature Branch Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Feature Branch:** \`${GITHUB_REF#refs/heads/}\`" >> $GITHUB_STEP_SUMMARY
          echo "**PMD Checks:** ${{ steps.pmd-check.outputs.pmd_passed }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.pmd-check.outputs.pmd_passed }}" = "true" ]; then
            echo "**Promotional Branch:** \`${{ steps.create-promo-branch.outputs.promo_branch }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Deployment:** ${{ steps.deploy-delta.outputs.deployment_success }}" >> $GITHUB_STEP_SUMMARY
            echo "**Org-Wide Coverage:** ${{ steps.apex.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Validation Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ **Status:** All validations passed - PR created/updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status:** Validation failed - Please fix issues" >> $GITHUB_STEP_SUMMARY
          fi
