# Rollback Explanation: Branch vs Org

## ✅ New Behavior: Pre-Deployment Validation (Like Change Sets)

The workflow now validates **BEFORE** deployment, just like Salesforce Change Sets!

---

## What Happens When Tests Fail

### Scenario: DevTrial Deployment

**Timeline:**
```
1. PR merged to CRM_DevTrial2 ✅
2. Pre-deployment validation:
   - Validate deployment syntax ✅
   - Run tests in org ✅
   - Check coverage ✅
3. If validation fails ❌:
   - Workflow FAILS ❌
   - Revert PR created ✅
   - NO DEPLOYMENT TO ORG ✅ (Nothing deployed!)
4. If validation passes ✅:
   - Deploy to CRM_DevTrial org ✅
   - Verify post-deployment ✅
```

**What Gets Reverted:**

| Location | Status | Action |
|----------|--------|--------|
| **CRM_DevTrial2 Branch** | ✅ Automatic | Revert PR removes changes from branch |
| **CRM_DevTrial Org** | ✅ No Action Needed | Nothing was deployed - validation prevented deployment |

### Scenario: SIT Deployment

**Timeline:**
```
1. PR merged to CRM_SITTrial ✅
2. Pre-deployment validation:
   - Validate deployment syntax ✅
   - Run tests in org ✅
   - Check coverage ✅
3. If validation fails ❌:
   - Workflow FAILS ❌
   - Revert PR created ✅
   - NO DEPLOYMENT TO ORG ✅ (Nothing deployed!)
4. If validation passes ✅:
   - Deploy to CRM_SITOrg ✅
   - Verify post-deployment ✅
```

**What Gets Reverted:**

| Location | Status | Action |
|----------|--------|--------|
| **CRM_SITTrial Branch** | ✅ Automatic | Revert PR removes changes from branch |
| **CRM_SITOrg** | ✅ No Action Needed | Nothing was deployed - validation prevented deployment |

---

## Why No Manual Org Rollback is Needed

### The New Flow (Like Change Sets):

1. **Pre-deployment validation happens FIRST** (Step 9)
   - Validates deployment syntax
   - Runs tests in org
   - Checks coverage
2. **Deployment happens ONLY if validation passes** (Step 10)
3. **If validation fails**, **nothing is deployed to org**
4. The revert PR removes changes from the **branch**

### Example:

```
Step 9: Pre-Deployment Validation
  → Validate syntax ✅
  → Run tests in org ✅
  → Check coverage ❌ FAILED (46% < 75%)
  → Workflow FAILS ❌
  → NO DEPLOYMENT TO ORG ✅

Step 9b: Create Revert PR
  → Revert PR removes changes from CRM_DevTrial2 branch ✅
  → Org never received the changes ✅
  → No rollback needed ✅
```

---

## What Needs Rollback

### ✅ Automatic (No Action Needed):
- **Branch changes** - Revert PR handles this automatically
- **Git history** - Revert commit created automatically
- **Org deployment** - **NOT NEEDED** - Validation prevents deployment if tests fail

### ✅ No Manual Action Required:
- **CRM_DevTrial Org** - Nothing deployed if validation fails
- **CRM_SITOrg** - Nothing deployed if validation fails

---

## How to Perform Manual Org Rollback

### Option 1: Use Destructive Changes (Recommended)

1. **Get the rollback package** (generated by workflow):
   ```bash
   # The workflow generates rollback-package/ directory
   # Contains list of components that were deployed
   ```

2. **Create destructiveChanges.xml**:
   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <Package xmlns="http://soap.sforce.com/2006/04/metadata">
     <types>
       <members>NewClass</members>
       <name>ApexClass</name>
     </types>
     <version>60.0</version>
   </Package>
   ```

3. **Deploy destructive changes**:
   ```bash
   sf project deploy start \
     --manifest destructiveChanges.xml \
     --target-org CRM_DevTrial \
     --post-destructive-changes destructiveChanges.xml
   ```

### Option 2: Manual Deletion in Org

1. Go to Setup → Apex Classes
2. Delete the deployed classes/components
3. Or use VS Code to delete and deploy

### Option 3: Redeploy Previous Version

1. Checkout the commit before merge
2. Deploy that version to org
3. This overwrites the failed deployment

---

## Current Workflow Behavior

### DevTrial Workflow:
```
✅ Pre-deployment validation (syntax, tests, coverage)
✅ Creates revert PR if validation fails
✅ NO deployment if validation fails
✅ Deployment only happens if validation passes
✅ No org rollback needed - nothing deployed if validation fails
```

### SIT Workflow:
```
✅ Pre-deployment validation (syntax, tests, coverage)
✅ Creates revert PR if validation fails
✅ NO deployment if validation fails
✅ Deployment only happens if validation passes
✅ No org rollback needed - nothing deployed if validation fails
```

---

## How Pre-Deployment Validation Works

**Step 1: Validate Deployment Syntax**
```bash
sf project deploy validate --source-dir changed-sources/force-app --target-org CRM_DevTrial
```
- Checks syntax errors
- Validates dependencies
- Ensures components can be deployed

**Step 2: Run Tests BEFORE Deployment**
```bash
sf apex run test --test-level RunLocalTests --target-org CRM_DevTrial
```
- Runs all tests in org
- Checks current org-wide coverage
- Ensures coverage > 75% before deployment

**Step 3: Deploy ONLY if Validation Passes**
```bash
sf project deploy start --source-dir changed-sources/force-app --target-org CRM_DevTrial --test-level RunLocalTests
```
- Deploys with test validation
- Tests run during deployment (like Change Sets)
- If tests fail during deployment, deployment is rolled back automatically by Salesforce

---

## Summary

| When Tests Fail | Branch Rollback | Org Rollback |
|----------------|-----------------|--------------|
| **DevTrial** | ✅ Automatic (Revert PR) | ✅ **NOT NEEDED** (Nothing deployed) |
| **SIT** | ✅ Automatic (Revert PR) | ✅ **NOT NEEDED** (Nothing deployed) |

**Key Points:** 
- ✅ **Pre-deployment validation** - Tests run BEFORE deployment (like Change Sets)
- ✅ **Branch revert is automatic** - Revert PR removes changes from branch
- ✅ **No org rollback needed** - Nothing is deployed if validation fails
- ✅ **Deployment only happens if validation passes** - Safe deployment process

---

## Future Enhancement (Optional)

We could add automatic org rollback by:
1. Storing deployment manifest before deployment
2. Creating destructiveChanges.xml automatically
3. Deploying destructive changes if tests fail

But this requires careful handling and may not work for all component types.
